# Communication Module — Production Data Migration

**Audience:** Internal (wwPDB sites)  
**Goal:** Migrate historical CIF-based messages to production database before backend switch-over.

---

## 1. Configuration Requirements

Add these messaging-specific variables to your site configuration:

````bash
# filepath: site.cfg
# ...existing code...

# Messaging database configuration
site_message_db_host_name = your_db_host         # Database server hostname
site_message_db_port_number = 3306               # Database port (default: 3306)
site_message_db_name = wwpdb_messaging          # Database name
site_message_db_user_name = messaging_user      # Database username
site_message_db_password = your_password        # Database password
site_message_db_socket = /path/to/socket        # Optional: Unix socket path

# ...existing code...
````

**Required configuration variables:**

- `SITE_MESSAGE_DB_HOST_NAME` - Database server hostname
- `SITE_MESSAGE_DB_USER_NAME` - Database username  
- `SITE_MESSAGE_DB_NAME` - Database name
- `SITE_MESSAGE_DB_PORT_NUMBER` - Database port (default: 3306)
- `SITE_MESSAGE_DB_PASSWORD` - Database password (can be empty)
- `SITE_MESSAGE_DB_SOCKET` - Optional Unix socket path

---

## 2. Database Schema

Three tables mirror mmCIF categories:

- **`pdbx_deposition_message_info`** - Main messages table
  - PK: `message_id`, FK: `parent_message_id` (self-reference)
  - Content types: `messages-to-depositor`, `messages-from-depositor`, `notes-from-annotator`

- **`pdbx_deposition_message_status`** - Message status tracking
  - FK: `message_id` → `pdbx_deposition_message_info`

- **`pdbx_deposition_message_file_reference`** - File attachments
  - FK: `message_id` → `pdbx_deposition_message_info`

---

## 3. Migration Scripts

### Database Initialization: `init_messaging_database.py`

Creates database and tables with proper indexes and foreign keys.

````bash
# Create schema in production
python init_messaging_database.py --site-id RCSB

# Verify existing schema only
python init_messaging_database.py --site-id RCSB --verify-only

# Drop and recreate (DESTRUCTIVE)
python init_messaging_database.py --site-id RCSB --drop-and-recreate
````

### Data Migration: `migrate_cif_to_db.py`

Migrates CIF messages to database. **Idempotent** - safe to re-run.

````bash
# Dry run (no database writes)
python migrate_cif_to_db.py --site-id RCSB --directory /path/to/D_* --dry-run

# Single deposition
python migrate_cif_to_db.py --site-id RCSB --deposition D_123456

# Bulk migration with logging
python migrate_cif_to_db.py --site-id RCSB --directory /path/to/D_* --json-log migration.json

# Create tables if needed
python migrate_cif_to_db.py --site-id RCSB --directory /path/to/D_* --create-tables
````

**Key behaviors:**

- Existing `message_id` entries are **skipped** (duplicate-safe)
- JSON logs record all operations for auditing
- UTF-8 encoding for message content
- Preserves parent-child message relationships

---

## 4. Migration Timeline

**Start:** Early September 2025 • **Switch-over:** October 2025 (TBD)

### Phase A — Setup (Early Sep)

1. **Create production schema**

   ````bash
   python init_messaging_database.py --site-id <SITE>
   ````

2. **Validate with dry run**

   ````bash
   python migrate_cif_to_db.py --site-id <SITE> --directory /path/to/messages --dry-run
   ````

### Phase B — Historical Load (Sep)

1. **Bulk migration**

   ````bash
   python migrate_cif_to_db.py --site-id <SITE> --directory /path/to/messages --json-log backfill.json
   ````

2. **Validation** (End of Sep)
   - Compare row counts vs CIF inventories
   - Review JSON logs for errors

### Phase C — Delta Updates (Sep - Oct)

**Re-runs** to catch new CIF messages (duplicates are safely skipped):

````bash
python migrate_cif_to_db.py --site-id <SITE> --directory /path/to/messages --json-log delta-$(date +%F).json
````

### Phase D — Switch-over (Oct)

1. **Pause** new message creation
2. **Final migration run** (should show only duplicates)
3. **Switch backend** to database
4. **Smoke tests** and resume operations

### Phase E — Post-switchover (Post-Oct)

- Monitor operations
- Daily integrity checks

---

## 5. Verification

- **Row count parity** per deposition across all tables
- **Spot check** message content, parent/child relationships, file references
- **JSON log analysis** for error-free operations
- **Zero message loss** post switch-over

---

## 6. Rollback Plan

- Switch application back to CIF backend
- Database remains available for future migration attempts
- Re-run migration scripts (duplicate-safe)
- For complete reset: use `--drop-and-recreate`

### Database Export: `dump_db_to_cif.py`

Exports message data from database back to CIF format files. **Reverse operation** of `migrate_cif_to_db.py`.

````bash
# Export single deposition
python dump_db_to_cif.py --site-id RCSB --deposition D_123456

# Export multiple depositions
python dump_db_to_cif.py --site-id RCSB --depositions D_123456 D_789012

# Export all depositions from database
python dump_db_to_cif.py --site-id RCSB --all

# Custom output directory with logging
python dump_db_to_cif.py --site-id RCSB --all --output-dir /backup/cif-export --json-log export.json

# Overwrite existing files
python dump_db_to_cif.py --site-id RCSB --deposition D_123456 --overwrite
````

**Key features:**

- Uses `gemmi` library for proper CIF formatting
- ASCII escaping: `text.encode('ascii', 'backslashreplace').decode()`
- Structured JSON logging for audit trails
- Bulk export with progress reporting
- File organization by content type

### Query Recent Messages: `list_recent_messages.py`

Lists communications within a specified time period with filtering options. **Used by WFM** for parsing messages and loading into test databases.

````bash
# List all messages from last 7 days (JSON output for WFM)
python list_recent_messages.py --site-id WWPDB_DEPLOY_TEST --days 7

# List messages for specific depositions in last 30 days
python list_recent_messages.py --site-id RCSB --days 30 \
    --depositions D_1000000001 D_1000000002

# Filter by content type and keywords, output as CSV
python list_recent_messages.py --site-id PDBe --days 14 \
    --content-type messages-to-depositor \
    --keywords "validation" "error" \
    --format csv --output results.csv

# Filter by sender with human-readable output
python list_recent_messages.py --site-id WWPDB_DEPLOY_TEST --days 30 \
    --sender "annotator@example.com" \
    --format text

# Custom date range with compact JSON output
python list_recent_messages.py --site-id RCSB \
    --start-date 2025-10-01 --end-date 2025-10-31 \
    --format json --compact --output october.json

# Complex query with multiple filters and logging
python list_recent_messages.py --site-id RCSB --days 60 \
    --content-type messages-to-depositor messages-from-depositor \
    --keywords "coordinate" "validation" \
    --json-log query.log --log-level DEBUG
````

**Key features:**

- Date range queries using indexed `timestamp` field for performance
- Multiple output formats: **JSON** (default, WFM-compatible), **CSV** (spreadsheet analysis), **plain text** (human-readable)
- Filter by: deposition ID(s), content type, sender, keywords (AND logic)
- Includes message metadata: `message_id`, `deposition_data_set_id`, `timestamp`, `sender`, `message_subject`, `message_type`
- File attachments and status flags (`read_status`, `action_reqd`, `for_release`)
- Structured JSON logging for audit trails
- No flat file dependency - queries database directly
- Efficient pagination/streaming for large result sets

**Output formats:**

- **JSON** (default): Machine-readable format for WFM consumption
  ```json
  {
    "count": 42,
    "messages": [
      {
        "message_id": "MSG_001",
        "deposition_data_set_id": "D_1000000001",
        "timestamp": "2025-10-15T14:30:00",
        "sender": "annotator@example.com",
        "message_subject": "Validation Report",
        "content_type": "messages-to-depositor",
        "file_attachments": [...],
        "read_status": "N",
        "action_reqd": "Y"
      }
    ]
  }
  ```

- **CSV**: Spreadsheet-compatible format for analysis
  ```csv
  message_id,deposition_data_set_id,timestamp,sender,message_subject,...
  MSG_001,D_1000000001,2025-10-15T14:30:00,annotator@example.com,Validation Report,...
  ```

- **Text**: Human-readable format for quick review
  ```
  Found 42 message(s)
  ================================================================================
  
  Message 1:
    ID: MSG_001
    Deposition: D_1000000001
    Timestamp: 2025-10-15T14:30:00
    Sender: annotator@example.com
    Subject: Validation Report
    ...
  ```

---

## 7. Timeline Visualization

```mermaid
gantt
    title Communication Module Migration (Switch-over: October 2025)
    dateFormat  YYYY-MM-DD
    excludes    weekends

    section Phase A — Setup
    Create production schema          :a1, 2025-09-01, 3d
    Validate with dry run            :a2, 2025-09-04, 2d

    section Phase B — Historical Load
    Bulk historical migration        :b1, 2025-09-08, 15d
    Validation & count checks        :b2, 2025-09-25, 3d

    section Phase C — Delta Updates
    Re-runs for new messages         :c1, 2025-09-08, 25d

    section Phase D — Switch-over
    Final migration & backend switch :d1, 2025-10-06, 1d

    section Phase E — Post-switchover
    Monitoring & integrity checks    :e1, 2025-10-07, 5d
```
